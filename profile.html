<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - PLAYKERS BOOKING</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { 
            background: #ececf2; 
            margin: 0; 
            font-family: 'Montserrat', Arial, sans-serif; 
        }
        .profile-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        .profile-header {
            background: linear-gradient(100deg, #1a237e 60%, #3949ab 100%);
            color: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 24px rgba(26,35,126,0.10);
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #ffb300;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.5em;
            font-weight: bold;
            color: #1a237e;
        }
        .profile-info {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(26,35,126,0.10);
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .info-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .info-label {
            font-weight: bold;
            color: #1a237e;
            margin-bottom: 5px;
        }
        .info-value {
            color: #333;
        }
        .edit-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
        }
        .edit-btn:hover {
            background: #1565c0;
        }
        .back-btn {
            background: #ffb300;
            color: #1a237e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            text-decoration: none;
            display: inline-block;
        }
        .back-btn:hover {
            background: #ffa000;
        }
        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-left: 10px;
        }
        .logout-btn:hover {
            background: #d32f2f;
        }
        .activity-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(26,35,126,0.10);
        }
        .activity-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        .message.success {
            background: #4caf50;
            color: white;
        }
        .message.error {
            background: #f44336;
            color: white;
        }
        .message.warning {
            background: #ff9800;
            color: white;
        }
        .edit-form {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .edit-form input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .edit-form button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .edit-form button.cancel {
            background: #f44336;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #1a237e;
        }
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #1a237e;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        @media (max-width: 600px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            .profile-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar" id="avatar">U</div>
            <h1 id="user-name">User Profile</h1>
            <p id="user-email">Loading...</p>
        </div>

        <div class="profile-info">
            <h2>Personal Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Name</div>
                    <div class="info-value" id="profile-name">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value" id="profile-email">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Date of Birth</div>
                    <div class="info-value" id="profile-dob">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Place</div>
                    <div class="info-value" id="profile-place">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Phone</div>
                    <div class="info-value" id="profile-phone">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Member Since</div>
                    <div class="info-value" id="profile-created">-</div>
                </div>
            </div>
            
            <!-- Edit Form (Hidden by default) -->
            <div id="edit-form" class="edit-form">
                <h3>Edit Profile</h3>
                <input type="text" id="edit-name" placeholder="Full Name">
                <input type="email" id="edit-email" placeholder="Email Address">
                <input type="date" id="edit-dob" placeholder="Date of Birth">
                <input type="text" id="edit-place" placeholder="City/Location">
                <input type="tel" id="edit-phone" placeholder="Phone Number">
                <button onclick="saveProfile()">Save Changes</button>
                <button class="cancel" onclick="cancelEdit()">Cancel</button>
            </div>
            
            <button class="edit-btn" onclick="editProfile()" id="edit-btn">Edit Profile</button>
            <a href="index.html" class="back-btn">Back to Home</a>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="activity-section">
            <h2>Account Statistics</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="total-bookings">0</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="active-bookings">0</div>
                    <div class="stat-label">Active Bookings</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completed-bookings">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="days-member">0</div>
                    <div class="stat-label">Days as Member</div>
                </div>
            </div>
            
            <h2>Recent Activity</h2>
            <div id="activity-list">
                <div class="loading">Loading activity...</div>
            </div>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        let currentUser = null;
        let isEditing = false;

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!isLoggedIn || !user.id) {
                showMessage('Please login to view your profile', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            currentUser = user;
            loadUserProfile();
            loadUserStats();
            loadRecentActivity();
        });

        async function loadUserProfile() {
            try {
                // First try to get from localStorage
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                if (user.id) {
                    displayUserProfile(user);
                    return;
                }

                // If not in localStorage, try to fetch from server
                const response = await fetch(`http://localhost:5502/api/user/${user.id}`);
                
                if (response.ok) {
                    const userData = await response.json();
                    localStorage.setItem('user', JSON.stringify(userData));
                    displayUserProfile(userData);
                } else {
                    // Fallback to localStorage data
                    displayUserProfile(user);
                    showMessage('Using cached profile data', 'warning');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                // Fallback to localStorage data
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                displayUserProfile(user);
                showMessage('Using cached profile data', 'warning');
            }
        }

        function displayUserProfile(user) {
            // Update header
            const avatar = document.getElementById('avatar');
            const userName = document.getElementById('user-name');
            const userEmail = document.getElementById('user-email');
            
            avatar.textContent = user.name ? user.name.charAt(0).toUpperCase() : 'U';
            userName.textContent = user.name || 'User Profile';
            userEmail.textContent = user.email || 'Loading...';
            
            // Update profile info
            document.getElementById('profile-name').textContent = user.name || '-';
            document.getElementById('profile-email').textContent = user.email || '-';
            document.getElementById('profile-dob').textContent = user.dob ? formatDate(user.dob) : '-';
            document.getElementById('profile-place').textContent = user.place || '-';
            document.getElementById('profile-phone').textContent = user.phone || '-';
            
            // Format creation date
            const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-';
            document.getElementById('profile-created').textContent = createdDate;
        }

        function editProfile() {
            if (isEditing) {
                cancelEdit();
                return;
            }

            isEditing = true;
            const editForm = document.getElementById('edit-form');
            const editBtn = document.getElementById('edit-btn');
            
            // Populate form with current data
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            document.getElementById('edit-name').value = user.name || '';
            document.getElementById('edit-email').value = user.email || '';
            document.getElementById('edit-dob').value = user.dob || '';
            document.getElementById('edit-place').value = user.place || '';
            document.getElementById('edit-phone').value = user.phone || '';
            
            editForm.style.display = 'block';
            editBtn.textContent = 'Cancel Edit';
            editBtn.style.background = '#f44336';
        }

        function cancelEdit() {
            isEditing = false;
            const editForm = document.getElementById('edit-form');
            const editBtn = document.getElementById('edit-btn');
            
            editForm.style.display = 'none';
            editBtn.textContent = 'Edit Profile';
            editBtn.style.background = '#1976d2';
        }

        async function saveProfile() {
            const editBtn = document.getElementById('edit-btn');
            editBtn.disabled = true;
            editBtn.textContent = 'Saving...';

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const updatedData = {
                    name: document.getElementById('edit-name').value,
                    email: document.getElementById('edit-email').value,
                    dob: document.getElementById('edit-dob').value,
                    place: document.getElementById('edit-place').value,
                    phone: document.getElementById('edit-phone').value
                };

                // Validate required fields
                if (!updatedData.name || !updatedData.email) {
                    showMessage('Name and email are required', 'error');
                    return;
                }

                // Update localStorage
                const updatedUser = { ...user, ...updatedData };
                localStorage.setItem('user', JSON.stringify(updatedUser));

                // Try to update on server
                try {
                    const response = await fetch(`http://localhost:5502/api/user/${user.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedData)
                    });

                    if (response.ok) {
                        showMessage('Profile updated successfully!', 'success');
                        displayUserProfile(updatedUser);
                    } else {
                        showMessage('Profile updated locally. Server update failed.', 'warning');
                    }
                } catch (error) {
                    showMessage('Profile updated locally. Server update failed.', 'warning');
                }

                cancelEdit();
            } catch (error) {
                showMessage('Failed to update profile', 'error');
            } finally {
                editBtn.disabled = false;
                editBtn.textContent = 'Edit Profile';
                editBtn.style.background = '#1976d2';
            }
        }

        function loadUserStats() {
            // Mock statistics - in real app, these would come from the server
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const createdAt = user.createdAt ? new Date(user.createdAt) : new Date();
            const daysAsMember = Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24));

            document.getElementById('total-bookings').textContent = '5';
            document.getElementById('active-bookings').textContent = '2';
            document.getElementById('completed-bookings').textContent = '3';
            document.getElementById('days-member').textContent = daysAsMember;
        }

        function loadRecentActivity() {
            const activityList = document.getElementById('activity-list');
            
            // Mock activity data - in real app, this would come from the server
            const activities = [
                { action: 'Booked a turf', date: '2024-01-15', time: '14:30' },
                { action: 'Updated profile', date: '2024-01-10', time: '09:15' },
                { action: 'Completed booking', date: '2024-01-08', time: '16:45' },
                { action: 'Joined platform', date: '2024-01-01', time: '10:00' }
            ];

            if (activities.length === 0) {
                activityList.innerHTML = '<div class="activity-item"><span>No recent activity</span></div>';
                return;
            }

            activityList.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <span>${activity.action}</span>
                    <span style="color: #666; font-size: 0.9em;">
                        ${formatDate(activity.date)} at ${activity.time}
                    </span>
                </div>
            `).join('');
        }

        function logout() {
            // Clear localStorage
            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userId');
            
            showMessage('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 4000);
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                if (!isEditing) {
                    editProfile();
                }
            }
            if (e.key === 'Escape' && isEditing) {
                cancelEdit();
            }
        });
    </script>
</body>
</html>
